<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocabForge | Workspace</title>
    <style>
        :root {
            --primary: #1a237e; --secondary: #2962ff; --success: #00c853; --danger: #d50000;
            --bg-color: #f0f2f5; --text-main: #333; --sidebar-w: 250px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { display: flex; height: 100vh; background-color: var(--bg-color); color: var(--text-main); overflow: hidden; }
        
        .sidebar { width: var(--sidebar-w); background: #fff; border-right: 1px solid #e0e0e0; padding: 20px; display: flex; flex-direction: column; }
        .brand { font-size: 24px; font-weight: bold; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; text-align: center;}
        
        .user-badge { background: #e8eaf6; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 20px; font-weight: bold; color: var(--primary); border: 2px dashed var(--secondary); }
        .badge-student { background: #e0f2f1; color: #00695c; border-color: #00897b; }

        .nav-item { padding: 12px 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: 0.2s; color: #555; }
        .nav-item:hover, .nav-item.active { background: #e8eaf6; color: var(--primary); }
        
        .main-content { flex: 1; display: flex; flex-direction: column; padding: 20px 30px; overflow-y: auto; }
        .header { margin-bottom: 25px; }
        .header h1 { font-size: 28px; color: var(--primary); }
        .header p { color: #666; margin-top: 5px; }
        
        .view-section { display: none; flex-direction: column; height: 100%; }
        .view-section.active { display: flex; }

        /* Workspace Editor */
        .workspace { display: flex; gap: 20px; flex: 1; min-height: 0; }
        .panel { flex: 1; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { background: #fafafa; padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .panel-actions { display: flex; gap: 10px; }
        textarea { flex: 1; width: 100%; border: none; padding: 20px; font-family: 'Consolas', monospace; font-size: 14px; color: #333; resize: none; outline: none; background: #fafafa; }
        
        /* Buttons */
        button { border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; color: white; }
        .btn-run { background: var(--secondary); } .btn-run:hover { background: #1c44b2; }
        .btn-save { background: var(--success); } .btn-save:hover { background: #009624; }
        .btn-danger { background: var(--danger); } .btn-danger:hover { background: #9b0000; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: white; }
        
        iframe { width: 100%; height: 100%; border: none; background: #fff; }

        /* Library */
        .library-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .lib-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: space-between; height: 150px;}
        .lib-card h3 { color: var(--primary); margin-bottom: 10px; font-size: 18px; }
        .lib-actions { display: flex; gap: 8px; }
        .lib-actions button { flex: 1; padding: 10px 5px; font-size: 14px; }
        .cloud-status { padding: 15px; background: #e3f2fd; color: #1565c0; border-radius: 8px; margin-bottom: 20px; font-weight: bold; border: 1px solid #90caf9; }

        /* Settings Dashboard */
        .settings-card { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); max-width: 500px; }
        .settings-card h3 { margin-bottom: 15px; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px;}
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        .role-switch { display: flex; gap: 10px; margin-bottom: 20px; }
        .role-switch button { flex: 1; padding: 12px; font-size: 16px; }

        /* Modal Preview */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 95%; max-width: 900px; height: 85vh; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 15px 20px; background: #fafafa; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .btn-close { background: #ccc; color: #333; font-size: 16px; padding: 8px 20px;}
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand">üéì VocabForge</div>
        <div id="userBadge" class="user-badge">üë®‚Äçüè´ Ch·∫ø ƒë·ªô: Gi√°o Vi√™n</div>
        <div class="nav-item" id="nav-creator" onclick="switchTab('creator')">‚ö° Khung So·∫°n Th·∫£o</div>
        <div class="nav-item active" id="nav-library" onclick="switchTab('library')">‚òÅÔ∏è Kho ƒê√°m M√¢y</div>
        <div class="nav-item" id="nav-settings" onclick="switchTab('settings')">‚öôÔ∏è C√†i ƒê·∫∑t H·ªá Th·ªëng</div>
    </aside>

    <main class="main-content">
        <div id="view-creator" class="view-section">
            <div class="header">
                <h1>Workspace - Khung So·∫°n Th·∫£o</h1>
                <p>N∆°i b·ªá h·∫° d√°n m√£ ƒë·ªÉ ch·∫°y th·ª≠. Th·ª≠ xong ∆∞ng √Ω th√¨ copy d√°n v√†o c·ªôt B b√™n Google Sheets nh√©!</p>
            </div>
            <div class="workspace">
                <div class="panel">
                    <div class="panel-header">
                        <span>üíª HTML/Tailwind Editor</span>
                        <button class="btn-run" onclick="renderCode()">Ch·∫°y Th·ª≠ ‚ñ∂</button>
                    </div>
                    <textarea id="sourceCode" placeholder=""></textarea>
                </div>
                <div class="panel">
                    <div class="panel-header"><span>üì± Live Preview</span></div>
                    <iframe id="previewFrame" sandbox="allow-scripts"></iframe>
                </div>
            </div>
        </div>

        <div id="view-library" class="view-section active">
            <div class="header">
                <h1 id="libraryTitle">‚òÅÔ∏è Kho B√†i H·ªçc (ƒê·ªìng b·ªô Google Sheets)</h1>
                <p>D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông t·ª´ "Ng·ª± Th∆∞ Ph√≤ng".</p>
            </div>
            <div id="cloudMessage" class="cloud-status" style="display: none;">
                üí° Ch·∫ø ƒë·ªô Gi√°o Vi√™n: B·ªá h·∫° vui l√≤ng m·ªü file Google Sheets ƒë·ªÉ th√™m/s·ª≠a/x√≥a b√†i h·ªçc. Trang web n√†y s·∫Ω t·ª± ƒë·ªông hi·ªÉn th·ªã k·∫øt qu·∫£.
            </div>
            <div id="loadingSpinner" class="loader"></div>
            <div class="library-grid" id="libraryContainer"></div>
        </div>

        <div id="view-settings" class="view-section">
            <div class="header">
                <h1>‚öôÔ∏è Ph√¢n Quy·ªÅn Kh√¥ng Gian</h1>
                <p>Chuy·ªÉn ƒë·ªïi g√≥c nh√¨n gi·ªØa Th·∫ßy v√† Tr√≤.</p>
            </div>
            <div class="settings-card">
                <h3>üé≠ Chuy·ªÉn ƒê·ªïi Vai Tr√≤</h3>
                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">Chuy·ªÉn sang "H·ªçc Sinh" ƒë·ªÉ ·∫©n c√¥ng c·ª• ch·ªânh s·ª≠a.</p>
                <div class="role-switch">
                    <button class="btn-run" onclick="changeRole('teacher')">üë®‚Äçüè´ Gi√°o Vi√™n</button>
                    <button class="btn-save" onclick="changeRole('student')">üë®‚Äçüéì H·ªçc Sinh</button>
                </div>
                <div class="form-group" id="pinSetupGroup">
                    <label>Thi·∫øt l·∫≠p m√£ PIN Gi√°o Vi√™n:</label>
                    <input type="password" id="teacherPin" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng c·∫ßn b·∫£o m·∫≠t...">
                    <button class="btn-outline" onclick="savePin()" style="width: 100%; margin-top: 10px;">L∆∞u m√£ PIN</button>
                </div>
            </div>
        </div>
    </main>

    <div class="modal" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Xem Flashcard</h3>
                <button class="btn-close" onclick="closeModal()">ƒê√≥ng ‚úñ</button>
            </div>
            <iframe id="modalFrame" sandbox="allow-scripts" style="flex:1;"></iframe>
        </div>
    </div>

    <script>
        // ==========================================
        // üö® TH·∫¶N ƒê√É L·∫ÆP S·∫¥N ƒê∆Ø·ªúNG LINK TH·∫¨T C·ª¶A B·ªÜ H·∫† V√ÄO ƒê√ÇY, B·ªÜ H·∫† KH√îNG C·∫¶N S·ª¨A G√å N·ªÆA üö®
        const SHEET_LINK = 'https://docs.google.com/spreadsheets/d/1dZA9LTjrKEYZb6kUm4E7p2XLt5NBYqvnKmYarlpxCg/edit';
        // ==========================================

        let cloudData = []; 

        function applyRole() {
            const role = localStorage.getItem('userRole') || 'student'; 
            const badge = document.getElementById('userBadge');
            const navCreator = document.getElementById('nav-creator');
            const pinGroup = document.getElementById('pinSetupGroup');
            const cloudMsg = document.getElementById('cloudMessage');

            if (role === 'student') {
                badge.className = 'user-badge badge-student';
                badge.innerText = 'üë®‚Äçüéì Ch·∫ø ƒë·ªô: H·ªçc Sinh';
                navCreator.style.display = 'none'; 
                pinGroup.style.display = 'none'; 
                cloudMsg.style.display = 'none';
                
                if (document.getElementById('view-creator').classList.contains('active')) {
                    switchTab('library');
                }
            } else {
                badge.className = 'user-badge';
                badge.innerText = 'üë®‚Äçüè´ Ch·∫ø ƒë·ªô: Gi√°o Vi√™n';
                navCreator.style.display = 'block';
                pinGroup.style.display = 'block';
                cloudMsg.style.display = 'block';
            }
        }

        function changeRole(newRole) {
            const currentRole = localStorage.getItem('userRole') || 'student';
            if (currentRole === 'student' && newRole === 'teacher') {
                const savedPin = localStorage.getItem('teacherPin');
                if (savedPin) {
                    const enteredPin = prompt("Vui l√≤ng nh·∫≠p m√£ PIN:");
                    if (enteredPin !== savedPin) {
                        alert("‚ùå Sai m√£ PIN! Kh√¥ng th·ªÉ v√†o ng·ª± th∆∞ ph√≤ng!");
                        return;
                    }
                }
            }
            localStorage.setItem('userRole', newRole);
            applyRole();
            alert(newRole === 'teacher' ? "ƒê√£ m·ªü kh√≥a quy·ªÅn Gi√°o Vi√™n!" : "ƒê√£ chuy·ªÉn sang g√≥c ƒë·ªô H·ªçc Sinh!");
            switchTab('library');
        }

        function savePin() {
            const pin = document.getElementById('teacherPin').value;
            localStorage.setItem('teacherPin', pin);
            alert("ƒê√£ l∆∞u m√£ PIN an to√†n!");
            document.getElementById('teacherPin').value = '';
        }

        function switchTab(tabId) {
            document.querySelectorAll('.view-section').forEach(function(el) { el.classList.remove('active'); });
            document.querySelectorAll('.nav-item').forEach(function(el) { el.classList.remove('active'); });
            
            document.getElementById('view-' + tabId).classList.add('active');
            document.getElementById('nav-' + tabId).classList.add('active');
            
            if (tabId === 'library') fetchFromCloud();
        }

        function renderCode() {
            document.getElementById('previewFrame').srcdoc = document.getElementById('sourceCode').value;
        }

        // B·ªò GI·∫¢I M√É N√ÇNG C·∫§P V√Ä T·ª∞ ƒê·ªòNG T√ÅCH ID T·ª™ LINK D√ÄI
        async function fetchFromCloud() {
            const container = document.getElementById('libraryContainer');
            const spinner = document.getElementById('loadingSpinner');
            
            container.innerHTML = '';
            spinner.style.display = 'block';

            if (SHEET_LINK === 'D√ÅN_ƒê∆Ø·ªúNG_LINK_V√ÄO_ƒê√ÇY') {
                spinner.style.display = 'none';
                container.innerHTML = "<p style='color: #d50000; padding: 20px;'>‚ö†Ô∏è B·ªá h·∫° ch∆∞a d√°n Link Google Sheets v√†o m√£ ngu·ªìn!</p>";
                return;
            }

            let sheetId = SHEET_LINK;
            if (sheetId.includes('/d/')) {
                sheetId = sheetId.split('/d/')[1].split('/')[0];
            }

            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;

            try {
                const response = await fetch(url);
                if (response.status === 404) {
                    throw new Error("Kh√¥ng t√¨m th·∫•y file Google Sheets. C√≥ v·∫ª ƒë∆∞·ªùng link b·ªã thi·∫øu ch·ªØ r·ªìi!");
                }
                if (!response.ok) {
                    throw new Error("B·ªã ch·∫∑n truy c·∫≠p. C√≥ th·ªÉ file ch∆∞a ƒë∆∞·ª£c m·ªü kh√≥a 'B·∫•t k·ª≥ ai c√≥ ƒë∆∞·ªùng li√™n k·∫øt'.");
                }

                const text = await response.text();
                
                const jsonString = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                if (!jsonString) throw new Error("File tr·ªëng ho·∫∑c m√£ HTML ch∆∞a ƒë∆∞·ª£c d√°n v√†o √¥ B2.");

                const data = JSON.parse(jsonString);
                const rows = data.table.rows;
                cloudData = [];
                
                for (let i = 1; i < rows.length; i++) {
                    if (rows[i] && rows[i].c && rows[i].c[0] && rows[i].c[1] && rows[i].c[1].v) {
                        cloudData.push({
                            id: i,
                            title: rows[i].c[0].v || "B√†i h·ªçc kh√¥ng t√™n",
                            code: rows[i].c[1].v
                        });
                    }
                }

                spinner.style.display = 'none';
                renderLibrary();

            } catch (error) {
                spinner.style.display = 'none';
                let errMsg = error.message;
                if (error.name === 'TypeError') {
                    errMsg = "Tr√¨nh duy·ªát ch·∫∑n k·∫øt n·ªëi. Xin b·ªá h·∫° ki·ªÉm tra l·∫°i quy·ªÅn Chia s·∫ª c·ªßa file Sheets.";
                }
                container.innerHTML = `<p style='color: #d50000; padding: 20px; line-height: 1.6;'>‚ùå <b>H·ªá th·ªëng b√°o l·ªói:</b> ${errMsg}</p>`;
            }
        }

        function renderLibrary() {
            const container = document.getElementById('libraryContainer');
            if (cloudData.length === 0) {
                container.innerHTML = "<p style='color: #888; padding: 20px;'>Kho b√†i h·ªçc ƒëang tr·ªëng. B·ªá h·∫° h√£y v√†o Google Sheets g√µ T√™n b√†i h·ªçc (C·ªôt A) v√† d√°n M√£ Code (C·ªôt B).</p>"; 
                return;
            }
            
            let htmlContent = '';
            for (let i = 0; i < cloudData.length; i++) {
                const item = cloudData[i];
                htmlContent += '<div class="lib-card">' +
                    '<div>' +
                        '<h3>' + item.title + '</h3>' +
                    '</div>' +
                    '<div class="lib-actions">' +
                        '<button class="btn-run" onclick="viewCard(' + item.id + ')" style="font-size: 16px;">‚ñ∂ M·ªü H·ªçc Ngay</button>' +
                    '</div></div>';
            }
            container.innerHTML = htmlContent;
        }

        function viewCard(id) {
            let card = null;
            for(let i=0; i<cloudData.length; i++) { if(cloudData[i].id === id) { card = cloudData[i]; break; } }
            if (card) {
                document.getElementById('modalTitle').innerText = card.title;
                document.getElementById('modalFrame').srcdoc = card.code;
                document.getElementById('previewModal').classList.add('active');
            }
        }

        function closeModal() {
            document.getElementById('previewModal').classList.remove('active');
            document.getElementById('modalFrame').srcdoc = '';
        }

        applyRole();
        fetchFromCloud();
    </script>
</body>
</html>
