<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocabForge | Teacher Thinh</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        :root {
            --primary: #1a237e; --secondary: #2962ff; --success: #00c853; --danger: #d50000;
            --bg-color: #f0f2f5; --text-main: #333; --sidebar-w: 250px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { display: flex; height: 100vh; background-color: var(--bg-color); color: var(--text-main); overflow: hidden; }
        
        #admin-view { display: flex; width: 100%; height: 100%; }
        .sidebar { width: var(--sidebar-w); background: #fff; border-right: 1px solid #e0e0e0; padding: 20px; display: flex; flex-direction: column; }
        .brand { font-size: 24px; font-weight: bold; color: var(--primary); margin-bottom: 40px; }
        .nav-item { padding: 12px 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; font-weight: 500; color: #555; }
        .nav-item:hover, .nav-item.active { background: #e8eaf6; color: var(--primary); }
        
        .main-content { flex: 1; display: flex; flex-direction: column; padding: 20px 30px; overflow-y: auto; }
        .header { margin-bottom: 25px; }
        .header h1 { font-size: 28px; color: var(--primary); }
        .header p { color: #666; margin-top: 5px; }
        
        .view-section { display: none; flex-direction: column; height: 100%; }
        .view-section.active { display: flex; }

        .workspace { display: flex; gap: 20px; flex: 1; min-height: 0; }
        .panel { flex: 1; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { background: #fafafa; padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; }
        .panel-actions { display: flex; gap: 10px; }
        
        textarea { flex: 1; width: 100%; border: none; padding: 20px; font-family: 'Consolas', monospace; font-size: 14px; background: #fafafa; resize: none; outline: none; }
        button { border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
        .btn-run { background: var(--secondary); } .btn-save { background: var(--success); } .btn-danger { background: var(--danger); }
        iframe { width: 100%; height: 100%; border: none; background: #fff; }

        .library-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .lib-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); height: 160px; display: flex; flex-direction: column; justify-content: space-between;}
        .lib-actions { display: flex; gap: 8px; } .lib-actions button { flex: 1; font-size: 13px; padding: 8px 5px;}
        
        .settings-card { background: #fff; padding: 25px; border-radius: 12px; max-width: 500px; }
        .form-group { margin-bottom: 20px; } .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 90%; max-width: 800px; height: 80vh; border-radius: 12px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px 20px; background: #fafafa; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; }
        .btn-close { background: #ccc; color: #333; }
        
        #student-view { display: none; width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; background: #f0f2f5; z-index: 9999; }
        #student-view.active { display: block; }
    </style>
</head>
<body>

    <div id="admin-view">
        <aside class="sidebar">
            <div class="brand">üéì VocabForge</div>
            <div class="nav-item active" onclick="switchTab('creator')">‚ö° Tr√¨nh T·∫°o Flashcard</div>
            <div class="nav-item" onclick="switchTab('library')">üìö Kho T·ª´ V·ª±ng</div>
            <div class="nav-item" onclick="switchTab('settings')">‚öôÔ∏è C√†i ƒê·∫∑t L·ªõp H·ªçc</div>
        </aside>

        <main class="main-content">
            <div id="view-creator" class="view-section active">
                <div class="header">
                    <h1 id="welcomeText">Workspace - Nh·∫≠p D·ªØ Li·ªáu</h1>
                    <p>Ch·ªâ c·∫ßn d√°n c·∫•u tr√∫c JSON ch·ª©a t·ª´ v·ª±ng v√†o ƒë√¢y. Khung Flashcard ƒë√£ ƒë∆∞·ª£c t√≠ch h·ª£p s·∫µn!</p>
                </div>
                <div class="workspace">
                    <div class="panel">
                        <div class="panel-header">
                            <span>üíª JSON Data Editor</span>
                            <div class="panel-actions">
                                <button class="btn-run" onclick="renderPreview()">Kh·ªüi Ch·∫°y ‚ñ∂</button>
                                <button class="btn-save" onclick="saveFlashcard()">üíæ L∆∞u v√†o Kho</button>
                            </div>
                        </div>
                        <textarea id="sourceCode" placeholder='[
  {
    "word": "Watermelon",
    "meaning": "Qu·∫£ d∆∞a h·∫•u",
    "image": "https://images.unsplash.com/photo-1582281268140-522b9df1ad08"
  }
]'></textarea>
                    </div>
                    <div class="panel">
                        <div class="panel-header"><span>üì± Live Preview</span></div>
                        <iframe id="previewFrame" sandbox="allow-scripts"></iframe>
                    </div>
                </div>
            </div>

            <div id="view-library" class="view-section">
                <div class="header"><h1>üìö Kho T·ª´ V·ª±ng</h1></div>
                <div class="library-grid" id="libraryContainer"></div>
            </div>

            <div id="view-settings" class="view-section">
                <div class="header"><h1>‚öôÔ∏è C√†i ƒê·∫∑t H·ªá Th·ªëng</h1></div>
                <div class="settings-card">
                    <div class="form-group">
                        <label>T√™n Gi√°o Vi√™n:</label>
                        <input type="text" id="teacherName" placeholder="V√≠ d·ª•: Mr. Thinh Nguyen">
                    </div>
                    <button class="btn-run" onclick="saveSettings()" style="width: 100%; margin-bottom: 20px;">L∆∞u C√†i ƒê·∫∑t</button>
                    <button class="btn-danger" onclick="clearAllData()" style="width: 100%;">X√≥a s·∫°ch Kho T·ª´ V·ª±ng</button>
                </div>
            </div>
        </main>
    </div>

    <div class="modal" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Xem Flashcard</h3>
                <button class="btn-close" onclick="closeModal()">ƒê√≥ng ‚úñ</button>
            </div>
            <iframe id="modalFrame" sandbox="allow-scripts" style="flex:1;"></iframe>
        </div>
    </div>
    <div id="student-view"><iframe id="studentFrame" sandbox="allow-scripts" style="width:100%; height:100%; border:none;"></iframe></div>

    <script>
        // C·ªî M√ÅY R√ÅP KHUNG FLASHCARD C·ªê ƒê·ªäNH
        function generateFlashcardHTML(jsonData, title, teacher) {
            return `
            <!DOCTYPE html>
            <html lang="vi">
            <head>
            <meta charset="UTF-8">
            <style>
                body { font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; flex-direction: column; align-items: center; background: #f8f9fa; margin: 0; padding: 20px; }
                .header { text-align: center; margin-bottom: 20px; }
                .header h2 { color: #1a237e; margin: 0; }
                .header p { color: #7f8c8d; font-size: 14px; margin: 5px 0 20px; }
                .progress { width: 100%; max-width: 400px; height: 6px; background: #e0e0e0; border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
                .progress-bar { height: 100%; background: #2962ff; width: 0%; transition: 0.3s; }
                .card-container { width: 100%; max-width: 400px; height: 280px; perspective: 1000px; cursor: pointer; }
                .card { width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d; }
                .card.is-flipped { transform: rotateY(180deg); }
                .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
                .card-front img { width: 100%; height: 100%; object-fit: cover; }
                .card-back { transform: rotateY(180deg); font-size: 36px; font-weight: bold; color: #333; text-align: center; padding: 20px; }
                .meaning { font-size: 18px; color: #666; margin-top: 10px; font-weight: normal; }
                .controls { display: flex; gap: 15px; margin-top: 20px; }
                button { padding: 10px 20px; border: none; border-radius: 6px; background: #1a237e; color: white; font-size: 16px; cursor: pointer; }
                button:disabled { background: #ccc; cursor: not-allowed; }
            </style>
            </head>
            <body>
                <div class="header">
                    <h2>üéì \${title}</h2>
                    <p>Prepared by \${teacher}</p>
                </div>
                <div class="progress"><div class="progress-bar" id="bar"></div></div>
                <div class="card-container" onclick="flipCard()">
                    <div class="card" id="flashcard">
                        <div class="card-face card-front" id="front"></div>
                        <div class="card-face card-back" id="back"></div>
                    </div>
                </div>
                <div class="controls">
                    <button onclick="prev()" id="btnPrev">Previous</button>
                    <span id="counter" style="line-height: 40px; font-weight: bold; color:#555;"></span>
                    <button onclick="next()" id="btnNext">Next</button>
                </div>
                <script>
                    const data = \${jsonData};
                    let idx = 0;
                    function update() {
                        document.getElementById('flashcard').classList.remove('is-flipped');
                        setTimeout(() => {
                            if(data[idx].image) {
                                document.getElementById('front').innerHTML = '<img src="' + data[idx].image + '">';
                            } else {
                                document.getElementById('front').innerHTML = '<h2>' + data[idx].word + '</h2>';
                            }
                            document.getElementById('back').innerHTML = data[idx].word + '<div class="meaning">' + data[idx].meaning + '</div>';
                            document.getElementById('counter').innerText = (idx + 1) + " / " + data.length;
                            document.getElementById('bar').style.width = ((idx + 1) / data.length * 100) + '%';
                            document.getElementById('btnPrev').disabled = idx === 0;
                            document.getElementById('btnNext').disabled = idx === data.length - 1;
                        }, 150);
                    }
                    function flipCard() { document.getElementById('flashcard').classList.toggle('is-flipped'); }
                    function next() { if(idx < data.length - 1) { idx++; update(); } }
                    function prev() { if(idx > 0) { idx--; update(); } }
                    update();
                <\/script>
            </body>
            </html>
            `;
        }

        // ƒêI·ªÄU H∆Ø·ªöNG LINK H·ªåC SINH
        const urlParams = new URLSearchParams(window.location.search);
        const sharedData = urlParams.get('play');
        const teacherName = localStorage.getItem('teacherName') || "Teacher Thinh";

        if (sharedData) {
            document.getElementById('admin-view').style.display = 'none';
            document.getElementById('student-view').classList.add('active');
            try {
                const decompressed = LZString.decompressFromEncodedURIComponent(sharedData);
                const parsedData = JSON.parse(decompressed);
                const html = generateFlashcardHTML(JSON.stringify(parsedData.words), parsedData.title, parsedData.teacher);
                document.getElementById('studentFrame').srcdoc = html;
            } catch (e) {
                document.getElementById('student-view').innerHTML = '<h2 style="text-align:center; padding-top:50px;">Link b√†i h·ªçc b·ªã h·ªèng!</h2>';
            }
        } else {
            applySettings();
        }

        // C√ÅC CH·ª®C NƒÇNG QU·∫¢N TR·ªä
        function switchTab(tabId) {
            document.querySelectorAll('.view-section, .nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tabId).classList.add('active');
            event.currentTarget.classList.add('active');
            if (tabId === 'library') loadLibrary();
        }

        function renderPreview() {
            try {
                const jsonText = document.getElementById('sourceCode').value;
                const data = JSON.parse(jsonText);
                const html = generateFlashcardHTML(JSON.stringify(data), "B·∫£n Xem Th·ª≠", teacherName);
                document.getElementById('previewFrame').srcdoc = html;
            } catch (e) {
                alert("B·∫©m b·ªá h·∫°, m√£ JSON b·ªã sai c√∫ ph√°p. Xin ki·ªÉm tra l·∫°i d·∫•u ngo·∫∑c v√† d·∫•u ph·∫©y!");
            }
        }

        function saveFlashcard() {
            try {
                const jsonText = document.getElementById('sourceCode').value;
                const data = JSON.parse(jsonText);
                const title = prompt("T√™n b·ªô Flashcard:", "T·ª´ V·ª±ng Unit M·ªõi");
                if (!title) return;

                let library = JSON.parse(localStorage.getItem('vocabLibrary')) || [];
                library.push({ id: Date.now(), title: title, teacher: teacherName, words: data, date: new Date().toLocaleDateString('vi-VN') });
                localStorage.setItem('vocabLibrary', JSON.stringify(library));
                alert("ƒê√£ c·∫•t v√†o Kho T·ª´ V·ª±ng!");
                document.getElementById('sourceCode').value = ''; 
                document.getElementById('previewFrame').srcdoc = '';
            } catch(e) { alert("M√£ JSON l·ªói, kh√¥ng th·ªÉ l∆∞u!"); }
        }

        function loadLibrary() {
            const container = document.getElementById('libraryContainer');
            const library = JSON.parse(localStorage.getItem('vocabLibrary')) || [];
            if (library.length === 0) { container.innerHTML = "<p>Kho tr·ªëng.</p>"; return; }
            container.innerHTML = library.map(item => `
                <div class="lib-card">
                    <div><h3>\${item.title}</h3><div class="date">\${item.date} - \${item.words.length} t·ª´</div></div>
                    <div class="lib-actions">
                        <button class="btn-run" onclick="viewCard(\${item.id})">M·ªü</button>
                        <button class="btn-save" onclick="copyShareLink(\${item.id})">üîó Link</button>
                        <button class="btn-danger" onclick="deleteCard(\${item.id})">X√≥a</button>
                    </div>
                </div>
            `).join('');
        }

        function viewCard(id) {
            const library = JSON.parse(localStorage.getItem('vocabLibrary')) || [];
            const card = library.find(c => c.id === id);
            if (card) {
                document.getElementById('modalTitle').innerText = card.title;
                const html = generateFlashcardHTML(JSON.stringify(card.words), card.title, card.teacher);
                document.getElementById('modalFrame').srcdoc = html;
                document.getElementById('previewModal').classList.add('active');
            }
        }

        function closeModal() { document.getElementById('previewModal').classList.remove('active'); }
        function deleteCard(id) {
            if (confirm("X√≥a b·ªô n√†y vƒ©nh vi·ªÖn?")) {
                let lib = JSON.parse(localStorage.getItem('vocabLibrary')) || [];
                localStorage.setItem('vocabLibrary', JSON.stringify(lib.filter(c => c.id !== id)));
                loadLibrary(); 
            }
        }

        function copyShareLink(id) {
            const library = JSON.parse(localStorage.getItem('vocabLibrary')) || [];
            const card = library.find(c => c.id === id);
            if (card) {
                // Ch·ªâ n√©n D·ªØ Li·ªáu (r·∫•t nh·∫π), kh√¥ng n√©n to√†n b·ªô HTML
                const payload = JSON.stringify({ title: card.title, teacher: card.teacher, words: card.words });
                const compressed = LZString.compressToEncodedURIComponent(payload);
                const shareUrl = window.location.href.split('?')[0] + '?play=' + compressed;
                
                navigator.clipboard.writeText(shareUrl).then(() => alert("ƒê√£ ch√©p link! C·ª±c k·ª≥ nh·∫π v√† an to√†n."))
                .catch(() => prompt("Copy link sau:", shareUrl));
            }
        }

        function saveSettings() {
            localStorage.setItem('teacherName', document.getElementById('teacherName').value);
            applySettings(); alert("ƒê√£ c·∫≠p nh·∫≠t!");
        }
        function clearAllData() {
            if (confirm("Thi√™u r·ª•i to√†n b·ªô Kho?")) { localStorage.removeItem('vocabLibrary'); loadLibrary(); }
        }
        function applySettings() {
            const name = localStorage.getItem('teacherName');
            if (name) {
                document.getElementById('teacherName').value = name;
                document.getElementById('welcomeText').innerText = `Workspace c·ªßa \${name}`;
            }
        }
    </script>
</body>
</html>
