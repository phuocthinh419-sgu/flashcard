<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VocabForge | Workspace</title>
    
    <meta name="theme-color" content="#1a237e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3048/3048122.png">
    <link rel="manifest" href="./manifest.json">
    
    <style>
        :root { --primary: #1a237e; --secondary: #2962ff; --success: #00c853; --danger: #d50000; --bg-color: #f0f2f5; --text-main: #333; --sidebar-w: 250px; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { display: flex; height: 100vh; background-color: var(--bg-color); color: var(--text-main); overflow: hidden; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; opacity: 0; transition: opacity 0.3s; }
        .menu-btn { display: none; font-size: 24px; cursor: pointer; background: white; border: 1px solid #ccc; border-radius: 6px; padding: 5px 15px; color: var(--primary); margin-bottom: 15px; width: fit-content; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .btn-close-sidebar { display: none; background: none; border: none; font-size: 20px; cursor: pointer; color: #555; }
        .sidebar { width: var(--sidebar-w); background: #fff; border-right: 1px solid #e0e0e0; padding: 20px; display: flex; flex-direction: column; z-index: 1001; transition: transform 0.3s ease; }
        .brand { font-size: 24px; font-weight: bold; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; justify-content: space-between; gap: 10px; text-align: center;}
        .user-badge { background: #e8eaf6; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 20px; font-weight: bold; color: var(--primary); border: 2px dashed var(--secondary); }
        .badge-student { background: #e0f2f1; color: #00695c; border-color: #00897b; }
        .nav-item { padding: 12px 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: 0.2s; color: #555; display: flex; align-items: center;}
        .nav-item:hover, .nav-item.active { background: #e8eaf6; color: var(--primary); }
        .nav-item.install-btn { background: var(--secondary); color: white; margin-top: auto; justify-content: center; font-weight: bold; box-shadow: 0 4px 6px rgba(41,98,255,0.3);}
        .nav-item.install-btn:hover { background: #1c44b2; }
        .main-content { flex: 1; display: flex; flex-direction: column; padding: 20px 30px; overflow-y: auto; width: 100%; }
        .header { margin-bottom: 25px; } .header h1 { font-size: 28px; color: var(--primary); } .header p { color: #666; margin-top: 5px; }
        .view-section { display: none; flex-direction: column; height: 100%; } .view-section.active { display: flex; }
        .workspace { display: flex; gap: 20px; flex: 1; min-height: 0; }
        .panel { flex: 1; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { background: #fafafa; padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        textarea { flex: 1; width: 100%; border: none; padding: 20px; font-family: 'Consolas', monospace; font-size: 14px; color: #333; resize: none; outline: none; background: #fafafa; }
        button { border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; color: white; }
        .btn-run { background: var(--secondary); } .btn-run:hover { background: #1c44b2; }
        .btn-save { background: var(--success); } .btn-save:hover { background: #009624; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); } .btn-outline:hover { background: var(--primary); color: white; }
        iframe { width: 100%; height: 100%; border: none; background: #fff; }
        .library-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; padding-bottom: 30px;}
        .lib-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: space-between; height: 150px; border-left: 5px solid var(--secondary);}
        .lib-card h3 { color: var(--primary); margin-bottom: 10px; font-size: 18px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .lib-actions { display: flex; gap: 8px; } .lib-actions button { flex: 1; padding: 10px 5px; font-size: 14px; }
        .settings-card { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); max-width: 500px; margin: 0 auto 20px auto; width: 100%;}
        .settings-card h3 { margin-bottom: 15px; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px;}
        .form-group { margin-bottom: 15px; } .form-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        .role-switch { display: flex; gap: 10px; margin-bottom: 20px; } .role-switch button { flex: 1; padding: 12px; font-size: 16px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; padding: 15px; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 900px; height: 85vh; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 15px 20px; background: #fafafa; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .btn-close { background: #ccc; color: #333; font-size: 16px; padding: 8px 20px;}
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* C·ª≠a s·ªï h∆∞·ªõng d·∫´n c√†i App th·ªß c√¥ng */
        .install-modal-content { max-width: 400px; height: auto; text-align: center; padding: 30px 20px; }
        .install-icon { font-size: 40px; margin-bottom: 15px; }
        .install-step { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left; border-left: 4px solid var(--secondary); font-size: 15px; line-height: 1.5; color: #444;}
        
        @media (max-width: 768px) {
            .sidebar { position: fixed; transform: translateX(-100%); height: 100%; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            .sidebar.show { transform: translateX(0); }
            .btn-close-sidebar { display: block; } .menu-btn { display: block; } .main-content { padding: 15px; }
            .workspace { flex-direction: column; display: block;} .panel { min-height: 400px; margin-bottom: 20px;} .library-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="sidebarOverlay" class="overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <div class="brand"><span>üéì VocabForge</span><button class="btn-close-sidebar" onclick="toggleSidebar()">‚úñ</button></div>
        <div id="userBadge" class="user-badge">üë®‚Äçüè´ Ch·∫ø ƒë·ªô: Gi√°o Vi√™n</div>
        <div class="nav-item" id="nav-creator" onclick="switchTab('creator')">‚ö° Khung So·∫°n Th·∫£o</div>
        <div class="nav-item active" id="nav-library" onclick="switchTab('library')">‚òÅÔ∏è Kho ƒê√°m M√¢y</div>
        <div class="nav-item" id="nav-settings" onclick="switchTab('settings')">‚öôÔ∏è Ph√¢n Quy·ªÅn</div>
        
        <div class="nav-item install-btn" onclick="openInstallModal()">üì± C√†i ƒê·∫∑t App</div>
    </aside>

    <main class="main-content">
        <button class="menu-btn" onclick="toggleSidebar()">‚ò∞ Menu</button>
        <div id="view-creator" class="view-section">
            <div class="header"><h1>Workspace - Khung So·∫°n Th·∫£o</h1></div>
            <div class="workspace">
                <div class="panel">
                    <div class="panel-header"><span>üíª HTML Editor</span><button class="btn-run" onclick="renderCode()">Ch·∫°y Th·ª≠ ‚ñ∂</button></div>
                    <textarea id="sourceCode" placeholder="D√°n m√£ b√†i h·ªçc v√†o ƒë√¢y..."></textarea>
                </div>
                <div class="panel"><div class="panel-header"><span>üì± Live Preview</span></div><iframe id="previewFrame" sandbox="allow-scripts"></iframe></div>
            </div>
        </div>

        <div id="view-library" class="view-section active">
            <div class="header"><h1>‚òÅÔ∏è Kho B√†i H·ªçc</h1></div>
            <div id="loadingSpinner" class="loader" style="display: none;"></div>
            <div class="library-grid" id="libraryContainer"></div>
        </div>

        <div id="view-settings" class="view-section">
            <div class="header"><h1>‚öôÔ∏è C√†i ƒê·∫∑t H·ªá Th·ªëng</h1></div>
            <div class="settings-card">
                <h3>üé≠ Chuy·ªÉn ƒê·ªïi Vai Tr√≤</h3>
                <div class="role-switch">
                    <button class="btn-run" onclick="changeRole('teacher')">üë®‚Äçüè´ Gi√°o Vi√™n</button>
                    <button class="btn-save" onclick="changeRole('student')">üë®‚Äçüéì H·ªçc Sinh</button>
                </div>
                <div class="form-group" id="pinSetupGroup">
                    <label>M√£ PIN (Gi√°o vi√™n):</label>
                    <input type="password" id="teacherPin" placeholder="B·ªè tr·ªëng n·∫øu kh√¥ng c·∫ßn...">
                    <button class="btn-outline" onclick="savePin()" style="width: 100%; margin-top: 10px;">L∆∞u m√£ PIN</button>
                </div>
            </div>
        </div>
    </main>

    <div class="modal" id="previewModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modalTitle">Xem Flashcard</h3><button class="btn-close" onclick="closeModal()">ƒê√≥ng ‚úñ</button></div>
            <iframe id="modalFrame" sandbox="allow-scripts" style="flex:1;"></iframe>
        </div>
    </div>

    <div class="modal" id="installModal">
        <div class="modal-content install-modal-content">
            <div class="install-icon">üì±</div>
            <h3 style="color: var(--primary); margin-bottom: 10px;">C√†i ƒë·∫∑t VocabForge</h3>
            <p style="color: #666; font-size: 14px;">Th√™m ·ª©ng d·ª•ng v√†o m√†n h√¨nh ch√≠nh ƒë·ªÉ h·ªçc t·∫≠p ti·ªán l·ª£i h∆°n.</p>
            <div id="installAndroid" class="install-step" style="display: none;">
                <b>D√†nh cho Android (Chrome/C·ªëc C·ªëc):</b><br>
                B·∫•m v√†o bi·ªÉu t∆∞·ª£ng <b>3 ch·∫•m ‚ãÆ</b> ·ªü g√≥c ph·∫£i tr√¨nh duy·ªát -> Ch·ªçn <b>"Th√™m v√†o m√†n h√¨nh ch√≠nh"</b>.
            </div>
            <div id="installIOS" class="install-step" style="display: none;">
                <b>D√†nh cho iPhone/iPad (Safari):</b><br>
                B·∫•m v√†o bi·ªÉu t∆∞·ª£ng <b>Chia s·∫ª ‚çê</b> ·ªü d∆∞·ªõi c√πng -> Vu·ªët l√™n ch·ªçn <b>"Th√™m v√†o MH ch√≠nh"</b> (Add to Home Screen).
            </div>
            <button class="btn-run" style="width: 100%; margin-top: 15px;" onclick="closeInstallModal()">ƒê√£ hi·ªÉu</button>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. K√çCH HO·∫†T PWA SERVICE WORKER
        // ==========================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('ƒê√£ n·∫°p Service Worker!'))
                    .catch(err => console.log('L·ªói n·∫°p SW:', err));
            });
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); 
            deferredPrompt = e; // Gi·ªØ l·∫°i s·ª± ki·ªán c√†i ƒë·∫∑t c·ªßa tr√¨nh duy·ªát
        });

        function openInstallModal() {
            if (deferredPrompt) {
                // N·∫øu tr√¨nh duy·ªát (Android) h·ªó tr·ª£, hi·ªán b·∫£ng c√†i ƒë·∫∑t g·ªëc c·ªßa m√°y
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(() => { deferredPrompt = null; });
            } else {
                // N·∫øu d√πng iOS ho·∫∑c ƒë√£ c√†i r·ªìi, hi·ªán b·∫£ng h∆∞·ªõng d·∫´n th·ªß c√¥ng
                document.getElementById('installModal').classList.add('active');
                const isIOS = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
                document.getElementById('installIOS').style.display = isIOS ? 'block' : 'none';
                document.getElementById('installAndroid').style.display = isIOS ? 'none' : 'block';
            }
            if (window.innerWidth <= 768) toggleSidebar(); 
        }
        function closeInstallModal() { document.getElementById('installModal').classList.remove('active'); }


        // ==========================================
        // 2. K·∫æT N·ªêI D·ªÆ LI·ªÜU GOOGLE SHEETS
        // ==========================================
        const SHEET_LINK = 'https://docs.google.com/spreadsheets/d/1dZA9LTtjrKEYZb6kUm4E7p2XLt5NBYqvnKmYarIpxCg/edit?usp=sharing';
        let cloudData = []; 

        function toggleSidebar() { 
            document.getElementById('sidebar').classList.toggle('show'); 
            document.getElementById('sidebarOverlay').style.display = document.getElementById('sidebar').classList.contains('show') ? 'block' : 'none'; 
            document.getElementById('sidebarOverlay').style.opacity = document.getElementById('sidebar').classList.contains('show') ? '1' : '0'; 
        }
        
        function applyRole() {
            const role = localStorage.getItem('userRole') || 'teacher'; 
            document.getElementById('userBadge').className = role === 'student' ? 'user-badge badge-student' : 'user-badge';
            document.getElementById('userBadge').innerText = role === 'student' ? 'üë®‚Äçüéì H·ªçc Sinh' : 'üë®‚Äçüè´ Gi√°o Vi√™n';
            document.getElementById('nav-creator').style.display = role === 'student' ? 'none' : 'flex';
            document.getElementById('pinSetupGroup').style.display = role === 'student' ? 'none' : 'block';
            if (role === 'student' && document.getElementById('view-creator').classList.contains('active')) switchTab('library');
        }

        function changeRole(newRole) { 
            if (newRole === 'teacher') {
                const savedPin = localStorage.getItem('teacherPin');
                if (savedPin && prompt("Nh·∫≠p m√£ PIN Gi√°o Vi√™n:") !== savedPin) return alert("‚ùå Sai m√£ PIN!");
            }
            localStorage.setItem('userRole', newRole); applyRole(); switchTab('library');
        }

        function savePin() {
            localStorage.setItem('teacherPin', document.getElementById('teacherPin').value);
            alert("ƒê√£ l∆∞u m√£ PIN!"); document.getElementById('teacherPin').value = '';
        }

        function switchTab(tabId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tabId).classList.add('active');
            document.getElementById('nav-' + tabId).classList.add('active');
            if (window.innerWidth <= 768) toggleSidebar();
            if (tabId === 'library') fetchFromCloud();
        }

        function renderCode() { document.getElementById('previewFrame').srcdoc = document.getElementById('sourceCode').value; }

        async function fetchFromCloud() {
            const container = document.getElementById('libraryContainer');
            const spinner = document.getElementById('loadingSpinner');
            container.innerHTML = ''; spinner.style.display = 'block';

            let sheetId = SHEET_LINK.includes('/d/') ? SHEET_LINK.split('/d/')[1].split('/')[0] : SHEET_LINK;
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&t=${new Date().getTime()}`;

            try {
                const response = await fetch(url, { cache: "no-store" });
                if (!response.ok) throw new Error("B·ªã ch·∫∑n truy c·∫≠p. File ch∆∞a b·∫≠t Chia s·∫ª c√¥ng khai.");
                
                const text = await response.text();
                const jsonString = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                if (!jsonString) throw new Error("File r·ªóng ho·∫∑c m√£ HTML ch∆∞a ƒë√∫ng chu·∫©n.");

                const data = JSON.parse(jsonString);
                cloudData = [];
                for (let i = 1; i < data.table.rows.length; i++) {
                    const r = data.table.rows[i];
                    if (r && r.c && r.c[0] && r.c[1] && r.c[1].v) {
                        cloudData.push({ id: i, title: r.c[0].v || "B√†i h·ªçc", code: r.c[1].v });
                    }
                }
                spinner.style.display = 'none';
                renderLibrary();
            } catch (error) {
                spinner.style.display = 'none';
                container.innerHTML = `<p style='color: #d50000; padding: 20px;'>‚ùå <b>L·ªói:</b> ${error.message}</p>`;
            }
        }

        function renderLibrary() {
            const container = document.getElementById('libraryContainer');
            if (cloudData.length === 0) return container.innerHTML = "<p style='color: #888; padding: 20px;'>Kho b√†i h·ªçc ƒëang tr·ªëng.</p>"; 
            container.innerHTML = cloudData.map(item => `<div class="lib-card"><div><h3>${item.title}</h3></div><div class="lib-actions"><button class="btn-run" onclick="viewCard(${item.id})">‚ñ∂ M·ªü H·ªçc Ngay</button></div></div>`).join('');
        }

        function viewCard(id) {
            const card = cloudData.find(c => c.id === id);
            if (card) {
                document.getElementById('modalTitle').innerText = card.title;
                document.getElementById('modalFrame').srcdoc = card.code;
                document.getElementById('previewModal').classList.add('active');
            }
        }
        function closeModal() { document.getElementById('previewModal').classList.remove('active'); document.getElementById('modalFrame').srcdoc = ''; }
        
        applyRole(); fetchFromCloud();
    </script>
</body>
</html>
